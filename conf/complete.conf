# =============================================================================
# COMPLETE WEBSERV CONFIGURATION
# Combines all features from: cgi.conf, default.conf, test-features.conf,
# test.conf, and updated.conf
# =============================================================================

# Global Settings

# =============================================================================
# MAIN SERVER - Port 8080
# =============================================================================
server {
  listen 0.0.0.0:8080;
  root ./www;
  autoindex on;
  index index.html;

  # Error pages (must be inside server block)
  error_page 404 /404.html;
  error_page 500 502 503 504 /404.html;

  # ---------------------------------------------------------------------------
  # STATIC FILES - Main website
  # ---------------------------------------------------------------------------
  location / {
    root ./www;
    allow_methods GET;
    autoindex off;
    index index.html;
  }

  # ---------------------------------------------------------------------------
  # CGI SCRIPTS - Execute scripts
  # ---------------------------------------------------------------------------
  location /cgi-bin/ {
    cgi_root ./www/cgi-bin;
    cgi_extensions .pl .py .cgi .sh;
    allow_methods GET POST;
  }

  # ---------------------------------------------------------------------------
  # UPLOADS - File upload/download/delete
  # ---------------------------------------------------------------------------
  location /uploads/ {
    root ./www/uploads;
    allow_methods GET POST PUT DELETE;
    autoindex on;
    max_request_body 104857600; # 100 MB
  }

  # ---------------------------------------------------------------------------
  # REDIRECTS
  # ---------------------------------------------------------------------------
  # Redirect to 42 school
  location /42 {
    redirect 302 https://42.fr;
  }

  # Redirect to Google
  location /google {
    redirect 302 https://google.com;
  }

  # Redirect to GitHub
  location /github {
    redirect 302 https://github.com;
  }
}

# =============================================================================
# SECONDARY SERVER - Port 8081
# =============================================================================
server {
  listen 127.0.0.1:8081;
  root ./www;
  autoindex on;
  index index.html;

  # Error pages for secondary server
  error_page 404 /404.html;
  error_page 500 502 503 504 /404.html;

  # Redirect example
  location /old {
    redirect 301 /new;
  }

  location /new {
    root ./www;
    allow_methods GET;
    autoindex on;
    index index.html;
  }

  # Images with directory listing
  location /images/ {
    root ./www/image;
    allow_methods GET;
    autoindex on;
  }

  # CGI support on secondary server
  location /cgi-bin/ {
    cgi_root ./www/cgi-bin;
    cgi_extensions .pl .py .cgi .sh;
    allow_methods GET POST;
  }
}
