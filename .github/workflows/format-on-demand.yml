name: Format Code on Request

on:
  issue_comment:
    types: [created]

concurrency:
  group: format-${{ github.event.issue.number }}
  cancel-in-progress: true
jobs:
  format:
    # Only run on pull request comments
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/format')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Check user permission
        uses: actions-cool/check-user-permission@v2
        id: check-permission
        with:
          require: write
          username: ${{ github.event.comment.user.login }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Exit if no permission
        if: steps.check-permission.outputs.require-result == 'false'
        run: |
          echo "User ${{ github.event.comment.user.login }} does not have write permission"
          exit 1

      - name: React to comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: eyes

      - name: Get PR branch
        uses: xt0rted/pull-request-comment-branch@v2
        id: comment-branch

      - name: Checkout PR branch
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.comment-branch.outputs.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Format all C++ files
        run: |
          find . -type f \( -name "*.cpp" -o -name "*.hpp" -o -name "*.h" -o -name "*.c" -o -name "*.cc" -o -name "*.cxx" \) \
            ! -path "*/.*" \
            -exec clang-format -i --style=file {} +

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add -u
          git commit -m "style: format code with clang-format"
          git push

      - name: Add success reaction
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: hooray

      - name: Add reaction if no changes needed
        if: steps.check-changes.outputs.has_changes == 'false'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: '+1'
