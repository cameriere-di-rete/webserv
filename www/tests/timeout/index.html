<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Timeout Tests - webserv</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .two-column {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 30px;
      align-items: stretch;
    }

    .timer-column {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .timer-display {
      font-size: 5rem;
      font-weight: bold;
      text-align: center;
      padding: 40px 20px;
      background: #1e293b;
      border-radius: 15px;
      color: #f59e0b;
      font-family: monospace;
    }

    .timer-display.waiting {
      color: #f59e0b;
      animation: pulse 1s infinite;
    }

    .timer-display.success {
      color: #22c55e;
    }

    .timer-display.error {
      color: #ef4444;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    .status-message {
      text-align: center;
      font-size: 1rem;
      margin-top: 15px;
      padding: 10px;
      background: #1e293b;
      border-radius: 8px;
      color: #94a3b8;
    }

    .content-column h2:first-child {
      margin-top: 0;
    }

    @media (max-width: 768px) {
      .two-column {
        grid-template-columns: 1fr;
      }

      .timer-column {
        position: static;
      }
    }
  </style>
</head>

<body class="test-page">
  <div class="container">
    <a href="/tests/" class="back-link">‚Üê Back to Test Suite</a>
    <h1>‚è±Ô∏è Timeout Tests</h1>
    <p class="subtitle">Test CGI script timeout (server kills scripts after a while)</p>

    <div class="two-column">
      <!-- Left column: Timer -->
      <div class="timer-column">
        <div class="timer-display" id="timer-display">0.0s</div>
        <div class="status-message" id="status-message">Click the button to start the test</div>
      </div>

      <!-- Right column: Controls and info -->
      <div class="content-column">
        <div class="interactive">
          <p style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 1rem">
            This test calls a CGI script that runs forever. The server should kill it after a while and return a 504
            Gateway Timeout.
          </p>

          <label for="timeout-path">CGI Script Path:</label>
          <input type="text" id="timeout-path" value="/cgi-bin/infinite.sh" />

          <button id="test-btn">üöÄ Start Timeout Test</button>

          <div id="timeout-response" class="response-box"></div>
        </div>
      </div>
    </div>

    <h2 style="text-align: center;">How it works</h2>
    <div class="interactive" style="text-align: center; max-width: 600px; margin: 0 auto;">
      <p style="color: #94a3b8; font-size: 0.875rem;">
        <strong>infinite.sh</strong> is a CGI script that loops forever without producing output.<br><br>
        The server monitors CGI execution time and kills any script that exceeds the timeout,
        then returns a <strong>504 Gateway Timeout</strong> error with the custom error page.
      </p>
    </div>
  </div>

  <footer class="footer">webserv by fmartusc, edforte, lrocca</footer>

  <script type="module">
    import { renderStatus, renderPre, renderError } from '/tests/common.js';

    const timerDisplay = document.getElementById('timer-display');
    const statusMessage = document.getElementById('status-message');
    const responseDiv = document.getElementById('timeout-response');
    const testBtn = document.getElementById('test-btn');

    let timerInterval = null;
    let startTime = null;

    function updateTimer() {
      const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
      timerDisplay.textContent = elapsed + 's';
    }

    async function testTimeout() {
      const path = document.getElementById('timeout-path').value;

      // Reset UI
      responseDiv.innerHTML = '';
      responseDiv.classList.remove('show');
      timerDisplay.className = 'timer-display waiting';
      timerDisplay.textContent = '0.0s';
      statusMessage.textContent = '‚è≥ Waiting for server response...';
      testBtn.disabled = true;
      testBtn.textContent = '‚è≥ Running...';

      // Start timer
      startTime = Date.now();
      timerInterval = setInterval(updateTimer, 100);

      try {
        const res = await fetch(path);

        // Stop timer
        clearInterval(timerInterval);
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        timerDisplay.textContent = elapsed + 's';

        if (res.status === 504) {
          timerDisplay.className = 'timer-display success';
          statusMessage.textContent = '‚úÖ 504 Gateway Timeout after ' + elapsed + 's';
        } else {
          timerDisplay.className = 'timer-display error';
          statusMessage.textContent = '‚ö†Ô∏è Unexpected: ' + res.status;
        }

        const ok = res.status >= 200 && res.status < 400;
        renderStatus(responseDiv, res.status, res.statusText, res.status === 504 ? 'status-ok' : (ok ? 'status-ok' : 'status-error'));
        responseDiv.classList.add('show');

      } catch (e) {
        clearInterval(timerInterval);
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        timerDisplay.textContent = elapsed + 's';
        timerDisplay.className = 'timer-display error';
        statusMessage.textContent = '‚ùå Error: ' + e.message;
        renderError(responseDiv, e.message);
      } finally {
        testBtn.disabled = false;
        testBtn.textContent = 'üöÄ Start Timeout Test';
      }
    }

    // Make function available for button
    testBtn.addEventListener('click', testTimeout);
  </script>
</body>

</html>
