<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Request Limits - webserv</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    html,
    body {
      overflow: auto !important;
      height: auto !important;
      min-height: 100vh;
    }
  </style>
</head>

<body class="test-page">
  <div class="container">
    <a href="/tests/" class="back-link">‚Üê Back to Test Suite</a>
    <h1>ü§è Request Limits</h1>
    <p class="subtitle">Test request body size limits</p>

    <h2>Current Configuration</h2>
    <div class="interactive">
      <p style="color: #94a3b8; font-size: 0.875rem">
        The server is configured with <code>max_request_body</code> directive.
        Default is 4096 bytes. Requests exceeding this limit will receive a
        <strong>413 Payload Too Large</strong> response.<br>
        <strong>Note:</strong> POST creates new resources (409 if file exists), PUT overwrites existing files.
      </p>
    </div>

    <h2>Test Body Size Limit</h2>
    <div class="interactive">
      <label for="size-bytes">Body Size (bytes):</label>
      <input type="text" id="size-bytes" value="5000" />

      <label for="target-path">Target Path:</label>
      <input type="text" id="target-path" value="/uploads/" placeholder="/uploads/ or /test-files/size-test.txt" />

      <label for="request-method">Method:</label>
      <select id="request-method">
        <option value="POST">POST (to directory - creates new file)</option>
        <option value="PUT">PUT (to file - overwrites/creates)</option>
      </select>

      <button onclick="testBodySize()">Send Request</button>
      <div id="size-response" class="response-box"></div>
    </div>
  </div>

  <script type="module">
    import { renderStatus, renderPre, renderError } from '/tests/common.js';

    async function testBodySize() {
      const sizeBytes = parseInt(document.getElementById("size-bytes").value) || 1000;
      const targetPath = document.getElementById("target-path").value;
      const method = document.getElementById("request-method").value;
      await doSizeTest(sizeBytes, targetPath, method);
    }

    async function quickSizeTest(sizeBytes) {
      document.getElementById("size-bytes").value = sizeBytes;
      await doSizeTest(sizeBytes, "/uploads/", "POST");
    }

    // Make functions globally accessible for onclick handlers
    window.testBodySize = testBodySize;
    window.quickSizeTest = quickSizeTest;

    async function doSizeTest(sizeBytes, targetPath, method = "POST") {
      const responseDiv = document.getElementById("size-response");
      responseDiv.innerHTML = "";
      const body = "x".repeat(sizeBytes);
      try {
        const startTime = performance.now();
        const response = await fetch(targetPath, {
          method: method,
          body: body,
          headers: { "Content-Type": "text/plain" },
        });
        const endTime = performance.now();
        const text = await response.text();

        const statusClass = response.status >= 200 && response.status < 400 ? "status-ok" : "status-error";
        renderStatus(responseDiv, response.status, response.statusText, statusClass);
        responseDiv.appendChild(document.createElement("br"));
        const timeDiv = document.createElement("div");
        timeDiv.textContent = `Time: ${(endTime - startTime).toFixed(2)}ms`;
        responseDiv.appendChild(timeDiv);

        const sizeDiv = document.createElement("div");
        sizeDiv.textContent = `Request Body Size: ${sizeBytes} bytes (${(sizeBytes / 1024).toFixed(2)} KB)`;
        responseDiv.appendChild(sizeDiv);

        renderPre(responseDiv, "Response:", text.length > 500 ? text.substring(0, 500) + "..." : text || "(empty)");
        responseDiv.classList.add("show");
      } catch (e) {
        renderError(responseDiv, e.message);
      }
    }
  </script>

  <footer class="footer">webserv by fmartusc, edforte, lrocca</footer>
</body>

</html>
